#!/bin/bash

# é£ä¹¦ Webhook æœåŠ¡å™¨éƒ¨ç½²è„šæœ¬

set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²é£ä¹¦ Webhook æœåŠ¡å™¨..."

# æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker"
    exit 1
fi

# æ£€æŸ¥ Docker Compose æ˜¯å¦å®‰è£…
if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker Compose"
    exit 1
fi

# åˆ›å»ºå¿…è¦çš„ç›®å½•
echo "ğŸ“ åˆ›å»ºå¿…è¦çš„ç›®å½•..."
mkdir -p logs/nginx
mkdir -p ssl

# åœæ­¢ç°æœ‰å®¹å™¨
echo "ğŸ›‘ åœæ­¢ç°æœ‰å®¹å™¨..."
docker-compose down || true

# æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
echo "ğŸ”¨ æ„å»ºå¹¶å¯åŠ¨æœåŠ¡..."
docker-compose up -d --build

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
docker-compose ps

# æ£€æŸ¥å¥åº·çŠ¶æ€
echo "ğŸ¥ æ£€æŸ¥å¥åº·çŠ¶æ€..."
curl -f http://localhost/api/health || {
    echo "âŒ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
    docker-compose logs
    exit 1
}

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ“± Webhook URL: http://47.120.11.77/api/callback"
echo "ğŸ¥ Health Check: http://47.120.11.77/api/health"
echo "ğŸ“ Logs: http://47.120.11.77/api/logs"

# æ˜¾ç¤ºæ—¥å¿—
echo "ğŸ“‹ æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—..."
docker-compose logs --tail=50 