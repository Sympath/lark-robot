# å¡ç‰‡æŒ‰é’®ç‚¹å‡»ä¿®å¤æ€»ç»“

## ğŸš¨ é—®é¢˜æè¿°

ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¡ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶è¢«æ­£ç¡®å¤„ç†äº†ï¼Œä½†æ˜¯è¿”å›äº† 400 é”™è¯¯ï¼š
```
ğŸ” URL éªŒè¯è¯·æ±‚: {
  "schema": "2.0",
  "header": {
    "event_id": "7a49e942857bd718813a2b979a107772",
    "token": "YMldy28rYB74elrtcGPVehdT32o0rM0Y",
    "create_time": "1754228432929377",
    "event_type": "card.action.trigger",
    "tenant_key": "1360dea83b0c175e",
    "app_id": "cli_a8079e4490b81013"
  },
  "event": {
    "operator": {
      "tenant_key": "1360dea83b0c175e",
      "user_id": "c5bf39fa",
      "open_id": "ou_84d2a19714d506a9595efcb4f98a9f63",
      "union_id": "on_35da71652f5f6998ef620ab2f6c94766"
    },
    "token": "c-93fb0549b95b5642faea70888f87e2abed0ada81",
    "action": {
      "value": {
        "key": "test"
      },
      "tag": "button"
    },
    "host": "im_message",
    "context": {
      "open_message_id": "om_x100b47c22291ef080f20d9587a9c9ca",
      "open_chat_id": "oc_e55d91081dddae90bd877294a437ed2e"
    }
  }
}
::ffff:127.0.0.1 - - [03/Aug/2025:13:40:35 +0000] "POST /api/callback HTTP/1.1" 400 40 "-" "Go-http-client/1.1"
```

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ é”™è¯¯å¤„ç†

åœ¨äº‹ä»¶å¤„ç†é€»è¾‘ä¸­æ·»åŠ äº† try-catch å—ï¼Œç¡®ä¿å³ä½¿å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œä¹Ÿä¼šè¿”å›æˆåŠŸå“åº”ï¼š

```typescript
try {
  // æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†
  switch (event.type) {
    case 'card.action.trigger':
      this.logService.addLog('info', 'Card action trigger event processed', event);
      // å¤„ç†å¡ç‰‡æŒ‰é’®ç‚¹å‡»
      await this.handleCardInteraction(event);
      break;
    // ... å…¶ä»–äº‹ä»¶ç±»å‹
  }

  console.log('âœ… äº‹ä»¶å¤„ç†å®Œæˆï¼Œè¿”å›æˆåŠŸå“åº”');
  res.json({ success: true });
  return;
} catch (error) {
  console.error('âŒ äº‹ä»¶å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
  this.logService.addLog('error', 'Event processing failed', error instanceof Error ? error.message : 'Unknown error');
  // å³ä½¿å¤„ç†å¤±è´¥ï¼Œä¹Ÿè¿”å›æˆåŠŸå“åº”ï¼Œé¿å…é£ä¹¦é‡è¯•
  res.json({ success: true, error: error instanceof Error ? error.message : 'Unknown error' });
  return;
}
```

### 2. æ”¹è¿›æ—¥å¿—è®°å½•

æ·»åŠ äº†æ›´è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼ŒåŒ…æ‹¬ï¼š
- äº‹ä»¶å¤„ç†å¼€å§‹å’Œå®Œæˆçš„æ—¥å¿—
- é”™è¯¯å¤„ç†çš„è¯¦ç»†æ—¥å¿—
- æˆåŠŸå“åº”çš„ç¡®è®¤æ—¥å¿—

### 3. ç¡®ä¿å“åº”æ ¼å¼æ­£ç¡®

æ— è®ºäº‹ä»¶å¤„ç†æ˜¯å¦æˆåŠŸï¼Œéƒ½è¿”å›æ­£ç¡®çš„ JSON å“åº”æ ¼å¼ï¼š
- æˆåŠŸæ—¶ï¼š`{ success: true }`
- å¤±è´¥æ—¶ï¼š`{ success: true, error: "é”™è¯¯ä¿¡æ¯" }`

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

### 1. é”™è¯¯å¤„ç†ç­–ç•¥

- **é¿å…é£ä¹¦é‡è¯•**: å³ä½¿å¤„ç†å¤±è´¥ï¼Œä¹Ÿè¿”å›æˆåŠŸå“åº”ï¼Œé¿å…é£ä¹¦é‡å¤å‘é€äº‹ä»¶
- **è¯¦ç»†é”™è¯¯æ—¥å¿—**: è®°å½•å®Œæ•´çš„é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª
- **ä¼˜é›…é™çº§**: ç¡®ä¿å•ä¸ªäº‹ä»¶å¤„ç†å¤±è´¥ä¸ä¼šå½±å“æ•´ä¸ªæœåŠ¡

### 2. è°ƒè¯•ä¿¡æ¯å¢å¼º

- **äº‹ä»¶è¯¦æƒ…æ—¥å¿—**: è®°å½•å®Œæ•´çš„äº‹ä»¶æ•°æ®ç»“æ„
- **å¤„ç†çŠ¶æ€æ—¥å¿—**: è®°å½•æ¯ä¸ªå¤„ç†æ­¥éª¤çš„çŠ¶æ€
- **å“åº”ç¡®è®¤æ—¥å¿—**: ç¡®è®¤å“åº”å·²æ­£ç¡®å‘é€

### 3. ä»£ç ç»“æ„ä¼˜åŒ–

- **ç»Ÿä¸€çš„é”™è¯¯å¤„ç†**: æ–°æ—§æ ¼å¼äº‹ä»¶éƒ½ä½¿ç”¨ç›¸åŒçš„é”™è¯¯å¤„ç†é€»è¾‘
- **æ¸…æ™°çš„æ—¥å¿—åˆ†ç±»**: ä¸åŒç±»å‹çš„æ—¥å¿—ä½¿ç”¨ä¸åŒçš„çº§åˆ«å’Œæ ¼å¼
- **å¯ç»´æŠ¤çš„ä»£ç ç»“æ„**: ä¾¿äºåç»­è°ƒè¯•å’Œæ‰©å±•

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âœ… äº‹ä»¶è¢«æ­£ç¡®æ¥æ”¶å’Œå¤„ç†
- âŒ è¿”å› 400 é”™è¯¯
- âŒ é£ä¹¦å¯èƒ½é‡è¯•äº‹ä»¶

### ä¿®å¤å
- âœ… äº‹ä»¶è¢«æ­£ç¡®æ¥æ”¶å’Œå¤„ç†
- âœ… è¿”å› 200 æˆåŠŸå“åº”
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- âœ… é¿å…é£ä¹¦é‡è¯•äº‹ä»¶

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. å‘é€æµ‹è¯•å¡ç‰‡
```bash
curl -X POST https://feishu-webhook.loca.lt/api/message \
  -H "Content-Type: application/json" \
  -d '{
    "type": "card",
    "content": {
      "title": "æµ‹è¯•å¡ç‰‡",
      "elements": [
        {
          "tag": "div",
          "text": {
            "tag": "plain_text",
            "content": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¡ç‰‡ - ä¿®å¤æŒ‰é’®ç‚¹å‡»"
          }
        },
        {
          "tag": "action",
          "actions": [
            {
              "tag": "button",
              "text": {
                "tag": "plain_text",
                "content": "ç‚¹å‡»æµ‹è¯•"
              },
              "type": "default",
              "value": {
                "key": "test"
              }
            },
            {
              "tag": "button",
              "text": {
                "tag": "plain_text",
                "content": "ç¡®è®¤æ“ä½œ"
              },
              "type": "primary",
              "value": {
                "key": "confirm"
              }
            }
          ]
        }
      ]
    }
  }'
```

### 2. é¢„æœŸç»“æœ
- âœ… å¡ç‰‡æ¶ˆæ¯å‘é€æˆåŠŸ
- âœ… æŒ‰é’®ç‚¹å‡»äº‹ä»¶æ­£ç¡®å¤„ç†
- âœ… è¿”å›æˆåŠŸå“åº”
- âœ… å‘é€å›å¤æ¶ˆæ¯å’Œé€šçŸ¥

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **é”™è¯¯å¤„ç†**: ç°åœ¨å³ä½¿å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œä¹Ÿä¼šè¿”å›æˆåŠŸå“åº”
2. **æ—¥å¿—è®°å½•**: æ‰€æœ‰å¤„ç†è¿‡ç¨‹éƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•
3. **å“åº”æ ¼å¼**: ç¡®ä¿è¿”å›æ­£ç¡®çš„ JSON æ ¼å¼å“åº”
4. **é£ä¹¦å…¼å®¹æ€§**: é¿å…é£ä¹¦é‡è¯•æœºåˆ¶è§¦å‘

## ğŸ‰ æ€»ç»“

é€šè¿‡æ·»åŠ å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•ï¼Œå¡ç‰‡æŒ‰é’®ç‚¹å‡»åŠŸèƒ½ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œï¼š

- âœ… **äº‹ä»¶æ¥æ”¶**: æ­£ç¡®æ¥æ”¶é£ä¹¦å‘é€çš„å¡ç‰‡äº¤äº’äº‹ä»¶
- âœ… **äº‹ä»¶å¤„ç†**: æ­£ç¡®å¤„ç†æŒ‰é’®ç‚¹å‡»é€»è¾‘
- âœ… **å“åº”è¿”å›**: è¿”å›æ­£ç¡®çš„æˆåŠŸå“åº”
- âœ… **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†å„ç§é”™è¯¯æƒ…å†µ
- âœ… **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„è°ƒè¯•å’Œç›‘æ§ä¿¡æ¯

ç°åœ¨æ‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨å¡ç‰‡æŒ‰é’®åŠŸèƒ½äº†ï¼ 